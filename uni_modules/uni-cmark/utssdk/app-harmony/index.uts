/**
 * app-harmony/index.uts
 * ä¾¦æ¢è°ƒè¯• - æ­¥éª¤4: å®Œæ•´è°ƒç”¨æ‰€æœ‰å‡½æ•°
 * ç›®çš„ï¼šéªŒè¯å®Œæ•´åŠŸèƒ½ä¸é—ªé€€
 */

// å¯¼å…¥æ¥å£ç±»å‹å®šä¹‰
import { ParseMdRes, MarkdownToken } from '../interface.uts'

// æ­¥éª¤4ï¼šå¯¼å…¥ native æ¨¡å—
import cmark from 'libcmark.so'

/**
 * Markdown è½¬ JSON å‡½æ•°
 * æ­¥éª¤4: çœŸå®è°ƒç”¨ cmark.md2json()
 */
export function md2json(markdown: string): ParseMdRes {
  try {
    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] md2json è¢«è°ƒç”¨')
    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] è¾“å…¥é•¿åº¦:', markdown.length)
    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] å‡†å¤‡çœŸå®è°ƒç”¨ cmark.md2json()...')

    // çœŸå®è°ƒç”¨ md2json å‡½æ•°
    const jsonString: string = cmark.md2json(markdown)
    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] âœ… cmark.md2json() è¿”å›:', jsonString.substring(0, 100))

    const jsonArray = JSON.parseArray<MarkdownToken>(jsonString) as MarkdownToken[]

    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] ===== âœ… md2json å®Œæ•´è°ƒç”¨æˆåŠŸï¼token æ•°é‡:', jsonArray.length, '=====')
    return {
      data: jsonArray,
      errorMsg: ''
    }
  } catch (e) {
    console.error('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] ===== âŒ md2json è°ƒç”¨å¤±è´¥:', e, '=====')
    return {
      data: [],
      errorMsg: e.toString()
    }
  }
}

/**
 * åˆå§‹åŒ– cmark-gfm åº“
 * æ­¥éª¤4: çœŸå®è°ƒç”¨ cmark.initCmark()
 */
export async function initCmark() {
  try {
    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] ===== initCmark è¢«è°ƒç”¨ =====')
    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] å‡†å¤‡çœŸå®è°ƒç”¨ cmark.initCmark()...')

    // çœŸå®è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
    cmark.initCmark()

    // console.log('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] ===== âœ… cmark.initCmark() è°ƒç”¨æˆåŠŸï¼=====')
  } catch (e) {
    // console.error('ğŸ” [æ­¥éª¤4-ä¾¦æ¢] ===== âŒ cmark.initCmark() è°ƒç”¨å¤±è´¥:', e, '=====')
  }
}
