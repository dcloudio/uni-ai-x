<template>
	<view class="uni-ai-tool-bar">
		<!-- 复制按钮、重新回答按钮 -->
		<text class="uni-ai-tool-bar-btn uni-ai-tool-bar-btn-loop" @click="loop" v-if="msg.from_uid == 'uni-ai' && isLastAiMsg">{{loopIcon}}</text>
		<text class="uni-ai-tool-bar-btn uni-ai-tool-bar-btn-copy" @click="copy">{{copyIcon}}</text>
		<!-- <view class="btn"  @click="deleteMsg" v-if="aiState != 'processing'">
			<uni-icons class="delete" type="trash" size="22" color="#999"></uni-icons>
		</view> -->
	</view>
</template>

<script lang="uts" setup>
	import {uniAi, MsgItem} from '@/uni_modules/uni-ai-x/sdk';
	
	const props = defineProps<{
		msg: MsgItem
	}>()
	
	const msg = props.msg as MsgItem;
	
	const uicon = (code: string) => {
		// #ifdef APP
		let codes = code.split('%u');
		let chars = codes.map(code => {
			let hexCode = parseInt(code, 16);
			return String.fromCharCode(hexCode);
		});
		return chars.join('');
		// #endif
		// #ifndef APP
		return unescape(`%u${code}`) as string
		// #endif
	}
	
	const aiState = computed<string>(() => {
		return uniAi.currentChat!.state
	})
	
	const isLastAiMsg = computed<boolean>(() => {
		return msg._id == uniAi.lastAiMsg?._id
	})
	
	const copyIcon = computed<string>(() => {
		return uicon('e60c')
	})
	
	const loopIcon = computed<string>(() => {
		return uicon('e633')
	})
	
	const copy = () => {
		if (typeof msg.body != 'string') {
			uni.showToast({
				title: '消息内容不是字符串',
				icon: 'none',
			})
			return
		}
		uni.setClipboardData({
			data: msg.body as string,
			success: () => {
				uni.showToast({
					title: '复制成功',
					icon: 'success',
				})
			}
		})
		console.error('复制成功',msg.body)
	}
	
	const loop = async () => {
		if (uniAi.currentChat!.state == 'processing') {
			uniAi.currentChat!.state = 'stop'
			uniAi.abortRequest()
		}
		await nextTick()
		uniAi.resetMsg(msg)
		uniAi.answerQuestion(msg)
	}
	
	// const deleteMsg = () => {
	// 	uniAi.deleteMsg(msg._id)
	// }
</script>

<style lang="scss">
	@font-face {
		// #ifdef WEB
		font-display: swap;
		// #endif
		font-family: uniAiIconFontFamily;
		src: url('/uni_modules/uni-ai-x/static/font/iconfont.ttf');
	}
	@font-face {
		// #ifdef WEB
		font-display: swap;
		// #endif
		font-family: UniIconsFontFamily;
		src: url('/uni_modules/uni-icons/components/uni-icons/uniicons.ttf');
	}
	.uni-ai-tool-bar {
		width: 100%;
		flex-direction: row;
	}

	.uni-ai-tool-bar-btn {
		border-radius: 5px;
		width: 25px;
		height: 25px;
		font-size: 20px;
		line-height: 25px;
		text-align: center;
		margin-top: 5px;
		margin-right: 15px;
		color: var(--text-tertiary);
		transition: color 0.2s ease;
		/* #ifdef WEB */
		cursor: pointer;
		/* #endif */
	}

	.uni-ai-tool-bar-btn-copy {
		font-family: uniAiIconFontFamily;
	}

	.uni-ai-tool-bar-btn-loop {
		font-family: UniIconsFontFamily;
	}
</style>